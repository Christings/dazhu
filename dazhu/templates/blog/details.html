{% extends "base.html" %} 
{%load utils%}
<div></div>
{% block head %}
	<link rel="stylesheet" href="/static/css/validationEngine.jquery.css">
	<!--<link href="/static/ueditor/third-party/SyntaxHighlighter/shCoreEclipse.css"
		  rel="stylesheet" type="text/css" media="all" />-->
	<link href="/static/umeditor/themes/default/css/umeditor.min.css"
	  type="text/css" rel="stylesheet">
	<link href="/static/css/colorful.css"
	  type="text/css" rel="stylesheet">
	  <link href="/static/css/details.css"
	  type="text/css" rel="stylesheet">
{% endblock %}
{% block content %}
<section id="content">
	<div class="wrap-content">
		<div class="row block">
			<div id="main-content" class="col-2-3">
				<div class="wrap-col">
					<article >
						<div class="heading">
							<h2>
								<a href="#">{{blog.title}}</a>
							</h2>
						</div>

						{% if  user.is_authenticated %}
								<div><a href="/admin/blog/blogpost/{{blog.guid}}/change/">edit</a></div>
						{% endif %}

						<div id="blog_content" class="content">
							{% ifequal  blog.question "" %}
								{{blog.body|safe}}
							{% else %}
							    <div>
									回答问题查看文章 : {{ blog.question }}
									<br>
									<input style="border:1px solid black;" id="answerstr" type="text" value=""/>
									<input style="border:1px solid black;" id="doanswer" type="button" value="回答"/>
								</div>
							{% endifequal %}
						</div>
						<div class="info" >
							<p>
								来自 {{blog.author}} 写于 {{blog.timestamp|date:'Y-m-d H:i'}} -
								<a href="#">{{commentsCount}}
									条评论</a>
							</p>
						</div>
					</article>
					<section>
						<a id="anchor_scroll" href="#submit_reply" style="display:none">点击这里本页跳转</a>
						<h3 id="submit_reply">留下评论</h3>
						{% if blog.allow_comment %}
							<form id="contact-form" method="post">
								{% csrf_token %}
								<script src="/static/js/jquery.validationEngine-zh_CN.js"></script>
								<script src="/static/js/jquery.validationEngine.min.js"></script>
								<fieldset>
									<input type="hidden" name="aid" value='{{blog.guid}}' />
									<!--<label><input name="email" value="Email" onBlur="if(this.value=='') this.value='Email'" onFocus="if(this.value =='Email' ) this.value=''" /></label> -->
									<label><input name="user" placeholder="用户名" class="validate[required]"/></label>
									<!--<textarea name='message' id="id_body" style="height:100px;" class=""></textarea>-->
									<script type="text/javascript" charset="utf-8"
										src="/static/umeditor/umeditor.config.js"></script>
									<!--<script type="text/javascript" charset="utf-8"
										src="/static/umeditor/umeditor.min.js"></script>-->
									<script type="text/javascript" charset="utf-8"
										src="http://ueditor.baidu.com/umeditor/umeditor.min.js"></script>
									<script type="text/plain" name='message' id="id_body"
											style="width:100%;height:120px;"></script>

									<div class="buttons">
										<a href="#"
											onClick="document.getElementById('contact-form').reset()">清除</a>
										<a href="#" id='sendMsg' >发送</a>
									</div>
								</fieldset>
							</form>
						{% else %}
							<p>这篇文章不允许评论。</p>
						{% endif %}
						
					</section>
					<h4>评论:</h4>
					{% for cm in comments %}
					<div style="padding-top:2;padding-left:10;margin:0;">
						<div class="content">
							<p style="color:black;">
								● 来自 <span style="font-weight:bold;">{{cm.author|safe}}</span>
								写于 <span style="">{{cm.timestamp|date:'Y-m-d H:i'}}</span>
								<span class="reply_cms" cid="{{cm.id}}" cname="{{cm.author}}"
									  style="text-decoration:underline;cursor:pointer;">回复</span>
							</p>
							<div style="margin-left:20px;">{{cm.body|safe}}</div>
						</div>
					</div>
					{% endfor %}
				</div>
			</div>
			<div id="sidebar" class="col-1-3">
				<div class="wrap-col">					
					<div class="box">
						<div class="heading">
							<h2>文章分类</h2>
						</div>
						<div class="content">
							<ul>
								{% for cate in category %}
								<li><a href="/blog/catelist/{{cate.id}}">{{cate.title}}</a></li>
								{% endfor %}
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>
{% endblock %}
{% block script %}
<!--<script type="text/javascript"
		src="/static/ueditor/third-party/SyntaxHighlighter/shCore.js"></script>-->

<script type="text/javascript">
	$(function(){
		// SyntaxHighlighter.all();
		// var form = $("#contact-form");
		// form.validationEngine();
		$("#sendMsg").click(function(e){
			e.preventDefault();
			if(!form.validationEngine('validate')){
				return;
			}
			form.submit();
		});

		var ue = UM.getEditor('id_body', {
			toolbar: ['forecolor', 'backcolor', 'bold', 'fontfamily'
				, 'fontsize', 'emotion']
		});

		$("#doanswer").click(function(e){
			$.ajax({
				type: 'post',
				url: '/blog/get_content/',
				data: {aid:'{{ blog.guid }}',answer:$("#answerstr").val()},
				beforeSend: function(xhr) {
					xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
				},
				success: function(data) {
					if(data.indexOf("error")>-1){
						alert("答案错误!");
						return;
					}
					$("#blog_content").html(data);
				}
			});
		});

		$(".reply_cms").click(function(e){
			var cid = $(this).attr("cid");
			var cname = $(this).attr("cname");
			var content = "<span style='text-decoration:underline;cursor:pointer;color:blue;'>@"+
				cname+"</span>&nbsp;";
			UM.getEditor('id_body').setContent(content, false);
			document.getElementById("anchor_scroll").click();
		});
	});
</script>
{% endblock %}

